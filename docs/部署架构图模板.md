# 部署架构图模板

## 📋 模板使用说明

本模板用于设计和文档化系统的部署架构，包括环境规划、基础设施设计、服务部署和运维监控等方面。

---

## 🎯 部署架构概览

### 整体部署架构

```plantuml
@startuml 整体部署架构
!theme amiga
skinparam backgroundColor #f0f8ff

package "用户终端" {
  [Web浏览器] as web
  [移动APP] as mobile
  [第三方系统] as third
}

package "CDN/负载均衡层" {
  [CDN] as cdn
  [负载均衡器] as lb
}

package "应用服务层" {
  cloud "Kubernetes集群" {
    package "Web服务" {
      [Web Server 1] as web1
      [Web Server 2] as web2
      [Web Server 3] as web3
    }
    
    package "API服务" {
      [API Server 1] as api1
      [API Server 2] as api2
      [API Server 3] as api3
    }
    
    package "业务服务" {
      [用户服务] as user_svc
      [订单服务] as order_svc
      [支付服务] as pay_svc
    }
  }
}

package "数据存储层" {
  database "主数据库" {
    [MySQL Master] as mysql_m
    [MySQL Slave 1] as mysql_s1
    [MySQL Slave 2] as mysql_s2
  }
  
  database "缓存层" {
    [Redis Cluster] as redis
  }
  
  database "消息队列" {
    [RabbitMQ] as mq
  }
  
  database "文件存储" {
    [MinIO] as storage
  }
}

package "监控运维层" {
  [Prometheus] as prom
  [Grafana] as grafana
  [ELK Stack] as elk
  [Alertmanager] as alert
}

' 连接关系
web --> cdn
mobile --> cdn
third --> lb
cdn --> lb
lb --> web1
lb --> web2
lb --> web3

web1 --> api1
web2 --> api2
web3 --> api3

api1 --> user_svc
api2 --> order_svc
api3 --> pay_svc

user_svc --> mysql_m
order_svc --> mysql_m
pay_svc --> mysql_m

mysql_m --> mysql_s1
mysql_m --> mysql_s2

user_svc --> redis
order_svc --> redis
pay_svc --> redis

order_svc --> mq
pay_svc --> mq

api1 --> storage
api2 --> storage
api3 --> storage

prom --> web1
prom --> api1
prom --> mysql_m
grafana --> prom
elk --> web1
elk --> api1
alert --> prom

@enduml
```

### 网络架构图

```plantuml
@startuml 网络架构图
!theme amiga
skinparam backgroundColor #f0f8ff

package "互联网" {
  cloud "Internet" as internet
}

package "DMZ区域" {
  [WAF防火墙] as waf
  [负载均衡器] as nlb
  [Web服务器] as web_dmz
}

package "应用区域" {
  [应用服务器] as app_zone
  [API网关] as gateway
  [微服务集群] as microservices
}

package "数据区域" {
  [数据库服务器] as db_zone
  [缓存服务器] as cache_zone
  [文件服务器] as file_zone
}

package "管理区域" {
  [堡垒机] as bastion
  [监控服务器] as monitor
  [日志服务器] as log_server
}

' 网络连接
internet --> waf : "HTTPS:443"
waf --> nlb : "HTTP:80/443"
nlb --> web_dmz : "HTTP:8080"

web_dmz --> gateway : "HTTP:9000"
gateway --> microservices : "gRPC:50051"
microservices --> db_zone : "TCP:3306"
microservices --> cache_zone : "TCP:6379"
microservices --> file_zone : "HTTP:9001"

bastion --> app_zone : "SSH:22"
bastion --> db_zone : "SSH:22"
monitor --> app_zone : "HTTP:9090"
log_server --> app_zone : "UDP:514"

note right of waf : "防火墙策略\n- 仅允许443端口\n- DDoS防护\n- SQL注入防护"

note right of nlb : "负载均衡策略\n- 轮询算法\n- 健康检查\n- 会话保持"

note right of microservices : "服务发现\n- Consul\n- 服务注册\n- 健康检查"

@enduml
```

---

## 🏗️ 环境规划

### 环境架构矩阵

| 环境 | 用途 | 配置规模 | 访问控制 | 数据同步 |
|------|------|----------|----------|----------|
| **开发环境** | 日常开发测试 | 最小配置 | 开发团队 | 模拟数据 |
| **测试环境** | 功能验证 | 中等配置 | 测试团队 | 脱敏数据 |
| **预发环境** | 生产验证 | 生产配置 | 运维团队 | 生产数据副本 |
| **生产环境** | 线上服务 | 高可用配置 | 严格控制 | 实时数据 |

### 环境部署拓扑

```plantuml
@startuml 环境部署拓扑
!theme amiga
skinparam backgroundColor #f0f8ff

package "开发环境" as dev_env {
  [开发应用] as dev_app
  [开发数据库] as dev_db
  [Mock服务] as mock
}

package "测试环境" as test_env {
  [测试应用] as test_app
  [测试数据库] as test_db
  [自动化测试] as auto_test
}

package "预发环境" as staging_env {
  [预发应用] as staging_app
  [预发数据库] as staging_db
  [性能测试] as perf_test
}

package "生产环境" as prod_env {
  [生产应用集群] as prod_app
  [生产数据库集群] as prod_db
  [监控告警] as monitor
}

package "数据同步" {
  [数据脱敏工具] as mask_tool
  [数据同步工具] as sync_tool
}

' 部署流程
dev_app --> test_app : "CI/CD"
test_app --> staging_app : "自动部署"
staging_app --> prod_app : "手动发布"

' 数据同步
prod_db --> mask_tool : "数据备份"
mask_tool --> sync_tool : "脱敏处理"
sync_tool --> test_db : "定期同步"
sync_tool --> staging_db : "定期同步"

auto_test --> test_app : "自动测试"
perf_test --> staging_app : "性能测试"
monitor --> prod_app : "监控"

@enduml
```

---

## ☁️ 云架构设计

### 多云部署架构

```plantuml
@startuml 多云部署架构
!theme amiga
skinparam backgroundColor #f0f8ff

package "阿里云" as alicloud {
  package "华东区域" {
    [ECS集群] as ali_ecs
    [RDS数据库] as ali_rds
    [Redis缓存] as ali_redis
    [OSS存储] as ali_oss
  }
}

package "腾讯云" as tencentcloud {
  package "华南区域" {
    [CVM集群] as tc_cvm
    [CDB数据库] as tc_cdb
    [Redis缓存] as tc_redis
    [COS存储] as tc_cos
  }
}

package "AWS" as aws {
  package "美西区域" {
    [EC2集群] as aws_ec2
    [RDS数据库] as aws_rds
    [ElastiCache] as aws_cache
    [S3存储] as aws_s3
  }
}

package "全局负载均衡" {
  [DNS智能解析] as dns
  [全局负载均衡器] as global_lb
}

package "数据同步" {
  [跨云数据同步] as cross_sync
  [备份恢复系统] as backup_sys
}

package "统一监控" {
  [多云监控平台] as multi_monitor
  [日志聚合平台] as log_agg
}

' 用户访问
dns --> global_lb
global_lb --> ali_ecs : "就近访问"
global_lb --> tc_cvm : "就近访问"
global_lb --> aws_ec2 : "就近访问"

' 数据同步
ali_rds <--> cross_sync
tc_cdb <--> cross_sync
aws_rds <--> cross_sync

ali_oss --> backup_sys
tc_cos --> backup_sys
aws_s3 --> backup_sys

' 监控
ali_ecs --> multi_monitor
tc_cvm --> multi_monitor
aws_ec2 --> multi_monitor

ali_ecs --> log_agg
tc_cvm --> log_agg
aws_ec2 --> log_agg

@enduml
```

### 容器化部署架构

```plantuml
@startuml Kubernetes部署架构
!theme amiga
skinparam backgroundColor #f0f8ff

package "Kubernetes集群" {
  package "Master节点" {
    [API Server] as api_server
    [etcd] as etcd
    [Controller Manager] as controller
    [Scheduler] as scheduler
  }
  
  package "Worker节点1" {
    [kubelet] as kubelet1
    [kube-proxy] as proxy1
    package "Pods" {
      [Web Pod 1] as web_pod1
      [API Pod 1] as api_pod1
    }
  }
  
  package "Worker节点2" {
    [kubelet] as kubelet2
    [kube-proxy] as proxy2
    package "Pods" {
      [Web Pod 2] as web_pod2
      [API Pod 2] as api_pod2
    }
  }
  
  package "Worker节点3" {
    [kubelet] as kubelet3
    [kube-proxy] as proxy3
    package "Pods" {
      [Business Pod 1] as biz_pod1
      [Business Pod 2] as biz_pod2
    }
  }
}

package "外部服务" {
  [Ingress Controller] as ingress
  [Service Mesh] as istio
  [容器镜像仓库] as registry
  [持久化存储] as pv
}

package "CI/CD管道" {
  [GitLab] as gitlab
  [Jenkins] as jenkins
  [Harbor] as harbor
}

' 集群内部连接
api_server --> etcd
api_server --> controller
api_server --> scheduler

kubelet1 --> api_server
kubelet2 --> api_server
kubelet3 --> api_server

proxy1 --> api_server
proxy2 --> api_server
proxy3 --> api_server

' 外部服务连接
ingress --> web_pod1
ingress --> web_pod2

istio --> api_pod1
istio --> api_pod2
istio --> biz_pod1
istio --> biz_pod2

registry --> web_pod1
registry --> api_pod1
registry --> biz_pod1

pv --> biz_pod1
pv --> biz_pod2

' CI/CD流程
gitlab --> jenkins : "代码提交"
jenkins --> harbor : "构建镜像"
harbor --> registry : "推送镜像"
jenkins --> api_server : "部署应用"

@enduml
```

---

## 📊 服务部署规划

### 服务部署策略

| 服务类型 | 部署策略 | 实例数量 | 资源配置 | 扩缩容策略 |
|----------|----------|----------|----------|------------|
| **Web服务** | 蓝绿部署 | 3+ | 2C4G | 基于CPU使用率 |
| **API服务** | 滚动更新 | 5+ | 4C8G | 基于请求量 |
| **业务服务** | 金丝雀发布 | 3+ | 4C8G | 基于业务指标 |
| **数据服务** | 主从部署 | 1主2从 | 8C16G | 手动扩容 |
| **缓存服务** | 集群部署 | 3+ | 2C4G | 基于内存使用率 |

### 部署时序图

```plantuml
@startuml 应用部署时序
!theme amiga
participant "开发者" as dev
participant "GitLab" as git
participant "Jenkins" as ci
participant "Harbor" as harbor
participant "Kubernetes" as k8s
participant "监控系统" as monitor

dev -> git : 1. 提交代码
git -> ci : 2. 触发构建
ci -> ci : 3. 代码检查
ci -> ci : 4. 单元测试
ci -> harbor : 5. 构建镜像
ci -> k8s : 6. 部署到测试环境
ci -> ci : 7. 自动化测试
ci -> k8s : 8. 部署到预发环境
ci -> monitor : 9. 健康检查
dev -> ci : 10. 审批发布
ci -> k8s : 11. 生产环境发布
ci -> monitor : 12. 部署验证
monitor -> dev : 13. 部署结果通知

note right of ci : 每个阶段都有\n质量门禁检查
note right of k8s : 支持回滚机制
note right of monitor : 实时监控\n部署状态

@enduml
```

---

## 🔧 基础设施配置

### 服务器配置规范

#### 生产环境配置

```yaml
# Web服务器配置
web_servers:
  instance_type: "c5.xlarge"  # 4vCPU, 8GB RAM
  min_instances: 3
  max_instances: 10
  disk_size: "100GB SSD"
  network: "1Gbps"
  
# API服务器配置
api_servers:
  instance_type: "c5.2xlarge"  # 8vCPU, 16GB RAM
  min_instances: 5
  max_instances: 20
  disk_size: "200GB SSD"
  network: "10Gbps"
  
# 数据库服务器配置
database_servers:
  master:
    instance_type: "r5.4xlarge"  # 16vCPU, 128GB RAM
    disk_size: "2TB SSD"
    iops: 10000
    backup: "daily"
  slaves:
    count: 2
    instance_type: "r5.2xlarge"  # 8vCPU, 64GB RAM
    disk_size: "1TB SSD"
    iops: 5000
    
# 缓存服务器配置
cache_servers:
  redis_cluster:
    nodes: 6
    instance_type: "r5.large"  # 2vCPU, 16GB RAM
    memory: "15GB"
    persistence: true
```

#### 网络配置

```yaml
# VPC网络配置
vpc_config:
  cidr_block: "10.0.0.0/16"
  
  subnets:
    public:
      web_subnet_1: "10.0.1.0/24"  # 可用区1
      web_subnet_2: "10.0.2.0/24"  # 可用区2
      
    private:
      app_subnet_1: "10.0.11.0/24"  # 应用层
      app_subnet_2: "10.0.12.0/24"
      db_subnet_1: "10.0.21.0/24"   # 数据层
      db_subnet_2: "10.0.22.0/24"
      
# 安全组配置
security_groups:
  web_sg:
    inbound:
      - port: 80, source: "0.0.0.0/0"
      - port: 443, source: "0.0.0.0/0"
    outbound:
      - port: 8080, destination: "app_sg"
      
  app_sg:
    inbound:
      - port: 8080, source: "web_sg"
    outbound:
      - port: 3306, destination: "db_sg"
      - port: 6379, destination: "cache_sg"
      
  db_sg:
    inbound:
      - port: 3306, source: "app_sg"
```

---

## 📈 监控运维架构

### 监控架构图

```plantuml
@startuml 监控架构图
!theme amiga
skinparam backgroundColor #f0f8ff

package "数据采集层" {
  [Node Exporter] as node_exp
  [Application Metrics] as app_metrics
  [Log Agents] as log_agent
  [APM Agent] as apm_agent
}

package "数据存储层" {
  [Prometheus] as prometheus
  [InfluxDB] as influx
  [Elasticsearch] as es
  [Jaeger] as jaeger
}

package "数据处理层" {
  [Alertmanager] as alert_mgr
  [Logstash] as logstash
  [Fluentd] as fluentd
}

package "可视化层" {
  [Grafana] as grafana
  [Kibana] as kibana
  [Jaeger UI] as jaeger_ui
}

package "告警通知" {
  [邮件通知] as email
  [短信通知] as sms
  [钉钉通知] as dingtalk
  [PagerDuty] as pager
}

' 数据流向
node_exp --> prometheus : "系统指标"
app_metrics --> prometheus : "应用指标"
log_agent --> es : "日志数据"
apm_agent --> jaeger : "链路数据"

prometheus --> grafana : "指标查询"
prometheus --> alert_mgr : "告警规则"
es --> kibana : "日志查询"
jaeger --> jaeger_ui : "链路查询"

log_agent --> logstash : "日志处理"
logstash --> es : "结构化日志"

alert_mgr --> email : "告警通知"
alert_mgr --> sms : "告警通知"
alert_mgr --> dingtalk : "告警通知"
alert_mgr --> pager : "告警通知"

@enduml
```

### 监控指标体系

#### 基础设施监控

| 监控维度 | 关键指标 | 告警阈值 | 采集频率 |
|----------|----------|----------|----------|
| **CPU** | 使用率、负载 | >80% | 30s |
| **内存** | 使用率、可用内存 | >85% | 30s |
| **磁盘** | 使用率、IO等待 | >90% | 1m |
| **网络** | 带宽、丢包率 | >80% | 30s |

#### 应用监控

| 监控维度 | 关键指标 | 告警阈值 | 采集频率 |
|----------|----------|----------|----------|
| **请求量** | QPS、TPS | 基线±30% | 1m |
| **响应时间** | 平均、P95、P99 | >1s | 1m |
| **错误率** | 4xx、5xx错误率 | >1% | 1m |
| **业务指标** | 转化率、成功率 | 基线±20% | 5m |

### 日志管理架构

```plantuml
@startuml 日志管理架构
!theme amiga
skinparam backgroundColor #f0f8ff

package "应用服务器" {
  [Web应用] as web_app
  [API应用] as api_app
  [业务应用] as biz_app
}

package "日志采集" {
  [Filebeat] as filebeat
  [Fluent Bit] as fluentbit
  [Log4j Appender] as log4j
}

package "日志传输" {
  [Kafka] as kafka
  [Redis] as redis_log
}

package "日志处理" {
  [Logstash] as logstash
  [Fluentd] as fluentd
}

package "日志存储" {
  [Elasticsearch] as elasticsearch
  [ClickHouse] as clickhouse
  [HDFS] as hdfs
}

package "日志分析" {
  [Kibana] as kibana
  [Grafana] as grafana_log
  [自定义分析] as custom_analysis
}

' 日志流向
web_app --> filebeat : "文件日志"
api_app --> fluentbit : "容器日志"
biz_app --> log4j : "应用日志"

filebeat --> kafka : "批量传输"
fluentbit --> redis_log : "实时传输"
log4j --> kafka : "直接发送"

kafka --> logstash : "日志消费"
redis_log --> fluentd : "日志处理"

logstash --> elasticsearch : "结构化存储"
fluentd --> clickhouse : "高性能存储"
logstash --> hdfs : "长期存储"

elasticsearch --> kibana : "实时查询"
clickhouse --> grafana_log : "统计分析"
hdfs --> custom_analysis : "离线分析"

@enduml
```

---

## 🔐 安全架构设计

### 安全防护体系

```plantuml
@startuml 安全防护体系
!theme amiga
skinparam backgroundColor #f0f8ff

package "网络安全" {
  [DDoS防护] as ddos
  [WAF防火墙] as waf
  [网络隔离] as network_isolation
  [VPN接入] as vpn
}

package "应用安全" {
  [身份认证] as auth
  [访问控制] as access_control
  [数据加密] as encryption
  [API安全] as api_security
}

package "数据安全" {
  [数据脱敏] as data_mask
  [数据备份] as backup
  [权限管理] as permission
  [审计日志] as audit
}

package "运维安全" {
  [堡垒机] as bastion
  [密钥管理] as key_mgmt
  [漏洞扫描] as vuln_scan
  [安全监控] as security_monitor
}

package "合规审计" {
  [合规检查] as compliance
  [风险评估] as risk_assess
  [安全培训] as training
  [应急响应] as incident
}

' 安全层级
ddos --> waf : "第一道防线"
waf --> network_isolation : "应用防护"
network_isolation --> vpn : "内网访问"

auth --> access_control : "用户验证"
access_control --> encryption : "数据保护"
encryption --> api_security : "接口安全"

data_mask --> backup : "数据保护"
backup --> permission : "权限控制"
permission --> audit : "操作审计"

bastion --> key_mgmt : "运维管控"
key_mgmt --> vuln_scan : "安全检测"
vuln_scan --> security_monitor : "安全监控"

compliance --> risk_assess : "风险管理"
risk_assess --> training : "安全教育"
training --> incident : "应急处理"

@enduml
```

### 安全配置清单

#### 网络安全配置

```yaml
# 防火墙规则
firewall_rules:
  inbound:
    - name: "HTTP"
      port: 80
      protocol: "tcp"
      source: "0.0.0.0/0"
    - name: "HTTPS"
      port: 443
      protocol: "tcp"
      source: "0.0.0.0/0"
    - name: "SSH"
      port: 22
      protocol: "tcp"
      source: "管理IP段"
      
  outbound:
    - name: "Database"
      port: 3306
      protocol: "tcp"
      destination: "数据库IP段"

# SSL/TLS配置
ssl_config:
  certificate: "Let's Encrypt"
  protocols: ["TLSv1.2", "TLSv1.3"]
  cipher_suites: ["ECDHE-RSA-AES256-GCM-SHA384"]
  hsts_enabled: true
  hsts_max_age: 31536000
```

---

## 🚀 容灾备份方案

### 容灾架构图

```plantuml
@startuml 容灾架构图
!theme amiga
skinparam backgroundColor #f0f8ff

package "主数据中心" as main_dc {
  [主应用集群] as main_app
  [主数据库] as main_db
  [主存储] as main_storage
}

package "备数据中心" as backup_dc {
  [备应用集群] as backup_app
  [备数据库] as backup_db
  [备存储] as backup_storage
}

package "云端备份" as cloud_backup {
  [云存储] as cloud_storage
  [云数据库] as cloud_db
}

package "数据同步" {
  [实时同步] as real_sync
  [定时备份] as schedule_backup
  [增量备份] as incremental_backup
}

package "故障切换" {
  [自动切换] as auto_switch
  [手动切换] as manual_switch
  [健康检查] as health_check
}

' 数据同步
main_db --> real_sync : "实时复制"
real_sync --> backup_db : "同步数据"

main_storage --> schedule_backup : "定时备份"
schedule_backup --> backup_storage : "数据备份"

main_db --> incremental_backup : "增量备份"
incremental_backup --> cloud_storage : "云端存储"

' 故障切换
health_check --> main_app : "健康监控"
health_check --> auto_switch : "故障检测"
auto_switch --> backup_app : "自动切换"
manual_switch --> backup_app : "手动切换"

@enduml
```

### 备份恢复策略

| 数据类型 | 备份方式 | 备份频率 | 保留时间 | RTO | RPO |
|----------|----------|----------|----------|-----|-----|
| **核心数据库** | 实时同步+定时备份 | 15分钟 | 30天 | <5分钟 | <1分钟 |
| **业务数据** | 增量备份 | 1小时 | 7天 | <30分钟 | <1小时 |
| **文件存储** | 定时同步 | 6小时 | 30天 | <1小时 | <6小时 |
| **配置文件** | 版本控制 | 实时 | 永久 | <10分钟 | 0 |
| **日志数据** | 归档备份 | 1天 | 90天 | <2小时 | <24小时 |

---

## 📋 部署检查清单

### 部署前检查

#### 环境准备

- [ ] **服务器资源**：CPU、内存、磁盘、网络
- [ ] **网络配置**：VPC、子网、安全组、DNS
- [ ] **存储配置**：数据库、缓存、文件存储
- [ ] **负载均衡**：配置、健康检查、SSL证书
- [ ] **域名解析**：DNS配置、SSL证书

#### 应用配置

- [ ] **环境变量**：数据库连接、API密钥、配置参数
- [ ] **数据库初始化**：表结构、初始数据、索引
- [ ] **缓存配置**：Redis连接、缓存策略
- [ ] **消息队列**：队列配置、消费者设置
- [ ] **文件上传**：存储配置、权限设置

#### 安全配置

- [ ] **防火墙规则**：端口开放、IP白名单
- [ ] **SSL证书**：证书安装、HTTPS配置
- [ ] **访问控制**：用户权限、API限流
- [ ] **敏感信息**：密钥管理、数据加密
- [ ] **日志配置**：日志级别、审计日志

### 部署后验证

#### 功能验证

- [ ] **服务可用性**：所有服务正常启动
- [ ] **接口测试**：核心API功能正常
- [ ] **数据库连接**：读写操作正常
- [ ] **缓存功能**：缓存读写正常
- [ ] **文件上传**：文件存储正常

#### 性能验证

- [ ] **响应时间**：接口响应时间符合预期
- [ ] **并发处理**：负载测试通过
- [ ] **资源使用**：CPU、内存使用正常
- [ ] **数据库性能**：查询性能符合预期
- [ ] **网络带宽**：网络传输正常

#### 监控验证

- [ ] **监控数据**：指标采集正常
- [ ] **告警配置**：告警规则生效
- [ ] **日志收集**：日志正常输出
- [ ] **链路追踪**：分布式追踪正常
- [ ] **健康检查**：健康检查接口正常

---

## 🔧 运维工具配置

### CI/CD工具链

```plantuml
@startuml CI/CD工具链
!theme amiga
skinparam backgroundColor #f0f8ff

package "源码管理" {
  [GitLab] as gitlab
  [代码规范检查] as code_check
  [安全扫描] as security_scan
}

package "构建打包" {
  [Jenkins] as jenkins
  [Maven/Gradle] as build_tool
  [Docker] as docker
  [SonarQube] as sonar
}

package "制品管理" {
  [Harbor] as harbor
  [Nexus] as nexus
  [Artifactory] as artifactory
}

package "部署管理" {
  [Kubernetes] as k8s
  [Helm] as helm
  [Terraform] as terraform
  [Ansible] as ansible
}

package "测试工具" {
  [单元测试] as unit_test
  [集成测试] as integration_test
  [性能测试] as perf_test
  [安全测试] as sec_test
}

package "监控运维" {
  [Prometheus] as prometheus
  [Grafana] as grafana
  [ELK Stack] as elk
  [PagerDuty] as pagerduty
}

' 流程连接
gitlab --> code_check : "代码提交"
code_check --> security_scan : "规范检查"
security_scan --> jenkins : "触发构建"

jenkins --> build_tool : "编译构建"
build_tool --> docker : "镜像构建"
docker --> sonar : "质量检查"
sonar --> harbor : "推送镜像"

harbor --> helm : "镜像部署"
helm --> k8s : "应用部署"
terraform --> k8s : "基础设施"
ansible --> k8s : "配置管理"

jenkins --> unit_test : "单元测试"
k8s --> integration_test : "集成测试"
k8s --> perf_test : "性能测试"
k8s --> sec_test : "安全测试"

k8s --> prometheus : "指标采集"
prometheus --> grafana : "监控展示"
k8s --> elk : "日志采集"
prometheus --> pagerduty : "告警通知"

@enduml
```

### 运维脚本示例

#### 部署脚本

```bash
#!/bin/bash
# 应用部署脚本

set -e

APP_NAME="myapp"
VERSION=$1
ENVIRONMENT=$2
NAMESPACE="default"

if [ -z "$VERSION" ] || [ -z "$ENVIRONMENT" ]; then
    echo "Usage: $0 <version> <environment>"
    exit 1
fi

echo "部署应用: $APP_NAME"
echo "版本: $VERSION"
echo "环境: $ENVIRONMENT"

# 1. 验证环境
echo "验证Kubernetes连接..."
kubectl cluster-info

# 2. 更新镜像
echo "更新部署镜像..."
kubectl set image deployment/$APP_NAME \
    $APP_NAME=harbor.example.com/$APP_NAME:$VERSION \
    -n $NAMESPACE

# 3. 等待部署完成
echo "等待部署完成..."
kubectl rollout status deployment/$APP_NAME -n $NAMESPACE

# 4. 验证部署
echo "验证部署状态..."
kubectl get pods -l app=$APP_NAME -n $NAMESPACE

# 5. 健康检查
echo "执行健康检查..."
for i in {1..30}; do
    if curl -f http://service-url/health; then
        echo "健康检查通过"
        break
    fi
    echo "健康检查失败，重试中..."
    sleep 10
done

echo "部署完成"
```

#### 回滚脚本

```bash
#!/bin/bash
# 应用回滚脚本

set -e

APP_NAME="myapp"
NAMESPACE="default"

echo "开始回滚应用: $APP_NAME"

# 1. 查看历史版本
echo "查看部署历史..."
kubectl rollout history deployment/$APP_NAME -n $NAMESPACE

# 2. 执行回滚
echo "执行回滚..."
kubectl rollout undo deployment/$APP_NAME -n $NAMESPACE

# 3. 等待回滚完成
echo "等待回滚完成..."
kubectl rollout status deployment/$APP_NAME -n $NAMESPACE

# 4. 验证回滚
echo "验证回滚状态..."
kubectl get pods -l app=$APP_NAME -n $NAMESPACE

echo "回滚完成"
```

---

## 📊 成本优化建议

### 资源成本分析

| 资源类型 | 成本占比 | 优化建议 | 预期节省 |
|----------|----------|----------|----------|
| **计算资源** | 40% | 弹性伸缩、Spot实例 | 20-30% |
| **存储资源** | 25% | 数据分层、压缩 | 15-25% |
| **网络带宽** | 20% | CDN、压缩传输 | 10-20% |
| **数据库** | 10% | 读写分离、缓存 | 15-30% |
| **其他服务** | 5% | 按需使用、预留实例 | 10-15% |

### 自动化运维

```plantuml
@startuml 自动化运维流程
!theme amiga
skinparam backgroundColor #f0f8ff

[监控告警] --> [故障检测]
[故障检测] --> [自动修复]
[自动修复] --> [修复验证]
[修复验证] --> [通知运维]

[资源监控] --> [弹性伸缩]
[弹性伸缩] --> [实例调整]
[实例调整] --> [成本优化]

[定时任务] --> [数据备份]
[数据备份] --> [备份验证]
[备份验证] --> [清理过期]

[性能监控] --> [性能分析]
[性能分析] --> [优化建议]
[优化建议] --> [自动调优]

note right of [自动修复] : 重启服务\n清理缓存\n重建连接
note right of [弹性伸缩] : CPU > 80% 扩容\nCPU < 30% 缩容
note right of [备份验证] : 校验备份完整性\n测试恢复流程

@enduml
```

---

## 📚 相关文档

- [系统架构图模板](系统架构图模板.md)
- [技术选型决策表](技术选型决策表.md)
- [架构风险评估表](架构风险评估表.md)
- [接口设计规范](接口设计规范.md)

---

**创建时间**：{当前日期}  
**更新时间**：{当前日期}  
**版本号**：v1.0
