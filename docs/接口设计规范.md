# 接口设计规范

## 📋 规范使用说明

本规范用于统一项目中所有API接口的设计标准，确保接口的一致性、可维护性和可扩展性。

---

## 🎯 设计原则

### 核心原则

1. **🔗 RESTful设计**：遵循REST架构风格
2. **📝 统一规范**：保持接口风格一致
3. **🔒 安全第一**：考虑安全防护措施  
4. **⚡ 性能优化**：响应速度和资源利用
5. **📖 文档完整**：提供清晰的接口文档
6. **🔄 版本管理**：支持向后兼容

### 设计哲学

- **简洁明了**：接口设计应该直观易懂
- **职责单一**：每个接口只负责一个明确的功能
- **幂等性**：相同请求多次调用结果一致
- **无状态**：接口不依赖服务端状态

---

## 🌐 URL设计规范

### 基本结构

```
https://{domain}/{api-version}/{resource}/{resource-id}/{sub-resource}
```

### URL命名规则

#### ✅ 推荐做法

```bash
# 资源使用复数名词
GET    /api/v1/users          # 获取用户列表
GET    /api/v1/users/123      # 获取特定用户
POST   /api/v1/users          # 创建用户
PUT    /api/v1/users/123      # 更新用户
DELETE /api/v1/users/123      # 删除用户

# 嵌套资源
GET    /api/v1/users/123/orders     # 获取用户的订单
POST   /api/v1/users/123/orders     # 为用户创建订单

# 资源操作
POST   /api/v1/users/123/activate   # 激活用户
POST   /api/v1/orders/456/cancel    # 取消订单
```

#### ❌ 不推荐做法

```bash
# 使用动词
GET /api/v1/getUserList
POST /api/v1/createUser

# 使用单数
GET /api/v1/user
GET /api/v1/order

# 驼峰命名
GET /api/v1/userProfiles
GET /api/v1/orderItems
```

### 版本管理

#### 方式1：URL路径版本

```bash
GET /api/v1/users
GET /api/v2/users
```

#### 方式2：请求头版本

```bash
GET /api/users
Accept: application/vnd.api+json;version=1
```

#### 方式3：查询参数版本

```bash
GET /api/users?version=1
```

**推荐使用方式1（URL路径版本）**

---

## 🔧 HTTP方法规范

### 标准HTTP方法

| 方法 | 用途 | 幂等性 | 安全性 | 示例 |
|------|------|--------|--------|------|
| **GET** | 获取资源 | ✅ | ✅ | 查询用户信息 |
| **POST** | 创建资源 | ❌ | ❌ | 创建新用户 |
| **PUT** | 更新资源（完整） | ✅ | ❌ | 更新用户信息 |
| **PATCH** | 更新资源（部分） | ❌ | ❌ | 修改用户状态 |
| **DELETE** | 删除资源 | ✅ | ❌ | 删除用户 |
| **HEAD** | 获取资源头信息 | ✅ | ✅ | 检查资源存在性 |
| **OPTIONS** | 获取支持的方法 | ✅ | ✅ | CORS预检 |

### 使用场景

#### GET请求

```bash
# 获取资源列表
GET /api/v1/users?page=1&size=20&status=active

# 获取特定资源
GET /api/v1/users/123

# 获取嵌套资源
GET /api/v1/users/123/orders?status=pending
```

#### POST请求

```bash
# 创建资源
POST /api/v1/users
Content-Type: application/json

{
  "name": "张三",
  "email": "zhangsan@example.com"
}

# 执行操作
POST /api/v1/users/123/send-email
```

#### PUT请求

```bash
# 完整更新资源
PUT /api/v1/users/123
Content-Type: application/json

{
  "name": "李四",
  "email": "lisi@example.com",
  "status": "active"
}
```

#### PATCH请求

```bash
# 部分更新资源
PATCH /api/v1/users/123
Content-Type: application/json

{
  "status": "inactive"
}
```

---

## 📊 状态码规范

### 状态码分类

| 类别 | 范围 | 含义 | 使用场景 |
|------|------|------|----------|
| **1xx** | 100-199 | 信息性状态码 | 很少使用 |
| **2xx** | 200-299 | 成功状态码 | 请求成功处理 |
| **3xx** | 300-399 | 重定向状态码 | 资源位置改变 |
| **4xx** | 400-499 | 客户端错误 | 请求有误 |
| **5xx** | 500-599 | 服务端错误 | 服务器故障 |

### 常用状态码

#### 成功状态码 (2xx)

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| **200** | OK | GET、PUT、PATCH成功 |
| **201** | Created | POST创建成功 |
| **202** | Accepted | 请求已接受，异步处理 |
| **204** | No Content | DELETE成功，无返回内容 |

#### 客户端错误 (4xx)

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| **400** | Bad Request | 请求参数错误 |
| **401** | Unauthorized | 未认证 |
| **403** | Forbidden | 已认证但无权限 |
| **404** | Not Found | 资源不存在 |
| **405** | Method Not Allowed | HTTP方法不支持 |
| **409** | Conflict | 资源冲突 |
| **422** | Unprocessable Entity | 参数验证失败 |
| **429** | Too Many Requests | 请求频率超限 |

#### 服务端错误 (5xx)

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| **500** | Internal Server Error | 服务器内部错误 |
| **502** | Bad Gateway | 网关错误 |
| **503** | Service Unavailable | 服务不可用 |
| **504** | Gateway Timeout | 网关超时 |

---

## 📝 请求与响应格式

### 请求格式

#### Content-Type

```bash
# JSON格式（推荐）
Content-Type: application/json

# 表单格式
Content-Type: application/x-www-form-urlencoded

# 文件上传
Content-Type: multipart/form-data
```

#### 请求头示例

```http
POST /api/v1/users
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
User-Agent: MyApp/1.0.0
X-Request-ID: 550e8400-e29b-41d4-a716-446655440000
```

### 响应格式

#### 统一响应结构

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {
    // 业务数据
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### 成功响应示例

```json
// 获取单个资源
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": 123,
    "name": "张三",
    "email": "zhangsan@example.com",
    "status": "active",
    "createdAt": "2024-01-01T00:00:00Z"
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-123456"
}

// 获取资源列表
{
  "success": true,
  "code": 200,
  "message": "获取成功",
  "data": {
    "items": [
      {
        "id": 123,
        "name": "张三",
        "email": "zhangsan@example.com"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 100,
      "totalPages": 5
    }
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-123456"
}
```

#### 错误响应示例

```json
// 参数验证错误
{
  "success": false,
  "code": 422,
  "message": "参数验证失败",
  "data": null,
  "errors": [
    {
      "field": "email",
      "message": "邮箱格式不正确"
    },
    {
      "field": "name",
      "message": "姓名不能为空"
    }
  ],
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-123456"
}

// 业务逻辑错误
{
  "success": false,
  "code": 409,
  "message": "用户已存在",
  "data": null,
  "errorCode": "USER_ALREADY_EXISTS",
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-123456"
}
```

---

## 🔐 认证与授权

### 认证方式

#### JWT Bearer Token（推荐）

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### API Key

```http
Authorization: ApiKey your-api-key
# 或
X-API-Key: your-api-key
```

#### Basic认证

```http
Authorization: Basic base64(username:password)
```

### 授权响应

```json
// 认证失败
{
  "success": false,
  "code": 401,
  "message": "认证失败，请重新登录",
  "errorCode": "AUTHENTICATION_FAILED"
}

// 权限不足
{
  "success": false,
  "code": 403,
  "message": "权限不足，无法访问该资源",
  "errorCode": "INSUFFICIENT_PERMISSIONS"
}
```

---

## 📄 分页与筛选

### 分页参数

```bash
# 基于页码的分页
GET /api/v1/users?page=1&size=20

# 基于游标的分页
GET /api/v1/users?cursor=eyJpZCI6MTIzfQ&size=20
```

### 筛选与排序

```bash
# 筛选参数
GET /api/v1/users?status=active&role=admin&createdAfter=2024-01-01

# 排序参数
GET /api/v1/users?sort=createdAt:desc,name:asc

# 搜索参数
GET /api/v1/users?search=张三&searchFields=name,email
```

### 字段选择

```bash
# 只返回指定字段
GET /api/v1/users?fields=id,name,email

# 排除指定字段
GET /api/v1/users?exclude=password,secretKey
```

---

## ⚡ 性能优化

### 缓存策略

#### HTTP缓存头

```http
# 强制缓存
Cache-Control: max-age=3600, public

# 协商缓存
ETag: "33a64df551425fcc55e4d42a148795d9f25f89d4"
Last-Modified: Wed, 21 Oct 2015 07:28:00 GMT

# 禁用缓存
Cache-Control: no-cache, no-store, must-revalidate
```

#### 条件请求

```http
# 客户端请求
If-None-Match: "33a64df551425fcc55e4d42a148795d9f25f89d4"
If-Modified-Since: Wed, 21 Oct 2015 07:28:00 GMT

# 服务端响应
HTTP/1.1 304 Not Modified
```

### 压缩传输

```http
# 请求头
Accept-Encoding: gzip, deflate, br

# 响应头
Content-Encoding: gzip
```

### 批量操作

```bash
# 批量获取
GET /api/v1/users?ids=1,2,3,4,5

# 批量创建
POST /api/v1/users/batch
Content-Type: application/json

{
  "users": [
    {"name": "张三", "email": "zhangsan@example.com"},
    {"name": "李四", "email": "lisi@example.com"}
  ]
}

# 批量更新
PATCH /api/v1/users/batch
Content-Type: application/json

{
  "updates": [
    {"id": 1, "status": "active"},
    {"id": 2, "status": "inactive"}
  ]
}
```

---

## 🛡️ 安全规范

### 输入验证

```json
// 参数验证规则示例
{
  "name": {
    "type": "string",
    "required": true,
    "minLength": 2,
    "maxLength": 50,
    "pattern": "^[\\u4e00-\\u9fa5a-zA-Z\\s]+$"
  },
  "email": {
    "type": "string",
    "required": true,
    "format": "email"
  },
  "age": {
    "type": "integer",
    "minimum": 0,
    "maximum": 150
  }
}
```

### 敏感信息处理

```json
// 响应中隐藏敏感信息
{
  "id": 123,
  "name": "张三",
  "email": "zhan***@example.com",  // 脱敏处理
  "phone": "138****5678",          // 脱敏处理
  // "password": "..."             // 完全隐藏
}
```

### 频率限制

```http
# 响应头显示限流信息
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1640995200

# 超出限制时的响应
HTTP/1.1 429 Too Many Requests
{
  "success": false,
  "code": 429,
  "message": "请求频率超出限制",
  "retryAfter": 60
}
```

---

## 📋 错误处理规范

### 错误码设计

#### 业务错误码格式

```
[业务模块][错误类型][具体错误]
USER_VALIDATION_EMAIL_INVALID
ORDER_BUSINESS_INSUFFICIENT_STOCK
PAYMENT_EXTERNAL_GATEWAY_TIMEOUT
```

#### 错误码示例

| 错误码 | HTTP状态码 | 错误信息 | 解决方案 |
|--------|------------|----------|----------|
| USER_NOT_FOUND | 404 | 用户不存在 | 检查用户ID |
| USER_ALREADY_EXISTS | 409 | 用户已存在 | 使用其他邮箱 |
| INVALID_CREDENTIALS | 401 | 用户名或密码错误 | 重新输入 |
| INSUFFICIENT_PERMISSIONS | 403 | 权限不足 | 联系管理员 |
| VALIDATION_FAILED | 422 | 参数验证失败 | 检查输入参数 |

### 错误响应结构

```json
{
  "success": false,
  "code": 422,
  "message": "参数验证失败",
  "errorCode": "VALIDATION_FAILED",
  "errors": [
    {
      "field": "email",
      "message": "邮箱格式不正确",
      "code": "INVALID_EMAIL_FORMAT"
    }
  ],
  "requestId": "req-123456",
  "timestamp": "2024-01-15T10:30:00Z",
  "documentation": "https://api-docs.example.com/errors/VALIDATION_FAILED"
}
```

---

## 📖 接口文档规范

### OpenAPI规范

```yaml
openapi: 3.0.3
info:
  title: 用户管理API
  description: 用户管理系统接口文档
  version: 1.0.0
  contact:
    name: API支持
    email: api-support@example.com
    url: https://support.example.com

servers:
  - url: https://api.example.com/v1
    description: 生产环境
  - url: https://api-staging.example.com/v1
    description: 测试环境

paths:
  /users:
    get:
      summary: 获取用户列表
      description: 获取系统中所有用户的分页列表
      parameters:
        - name: page
          in: query
          description: 页码，从1开始
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: size
          in: query
          description: 每页数量
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: 获取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          description: 用户ID
          example: 123
        name:
          type: string
          description: 用户姓名
          example: "张三"
        email:
          type: string
          format: email
          description: 邮箱地址
          example: "zhangsan@example.com"
      required:
        - id
        - name
        - email
```

### 接口文档要素

#### 必须包含的信息

1. **接口描述**：清晰说明接口用途
2. **请求方法**：GET、POST、PUT、DELETE等
3. **请求URL**：完整的接口地址
4. **请求参数**：参数名、类型、是否必填、示例
5. **响应格式**：成功和失败的响应示例
6. **状态码**：可能返回的HTTP状态码
7. **错误码**：业务错误码及含义

#### 示例文档模板

```markdown
## 创建用户

### 接口信息
- **接口名称**：创建用户
- **接口地址**：`POST /api/v1/users`
- **接口描述**：创建新的系统用户

### 请求参数

**Headers**
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| Content-Type | string | 是 | application/json |
| Authorization | string | 是 | Bearer token |

**Body**
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| name | string | 是 | 用户姓名 | "张三" |
| email | string | 是 | 邮箱地址 | "zhangsan@example.com" |
| phone | string | 否 | 手机号码 | "13812345678" |

### 请求示例

```bash
curl -X POST https://api.example.com/v1/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "name": "张三",
    "email": "zhangsan@example.com",
    "phone": "13812345678"
  }'
```

### 响应示例

**成功响应 (201)**
```json
{
  "success": true,
  "code": 201,
  "message": "用户创建成功",
  "data": {
    "id": 123,
    "name": "张三",
    "email": "zhangsan@example.com",
    "phone": "13812345678",
    "status": "active",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

**错误响应 (422)**
```json
{
  "success": false,
  "code": 422,
  "message": "参数验证失败",
  "errorCode": "VALIDATION_FAILED",
  "errors": [
    {
      "field": "email",
      "message": "邮箱格式不正确"
    }
  ]
}
```

### 错误码说明

| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| USER_ALREADY_EXISTS | 409 | 邮箱已被注册 |
| VALIDATION_FAILED | 422 | 参数验证失败 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |
```

---

## 🧪 测试规范

### 接口测试用例

```json
{
  "testSuite": "用户管理接口测试",
  "testCases": [
    {
      "id": "TC001",
      "name": "创建用户_成功场景",
      "method": "POST",
      "url": "/api/v1/users",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer valid-token"
      },
      "body": {
        "name": "测试用户",
        "email": "test@example.com"
      },
      "expectedStatus": 201,
      "expectedResponse": {
        "success": true,
        "code": 201,
        "data.id": "exists",
        "data.email": "test@example.com"
      }
    },
    {
      "id": "TC002",
      "name": "创建用户_邮箱已存在",
      "method": "POST",
      "url": "/api/v1/users",
      "body": {
        "name": "测试用户",
        "email": "existing@example.com"
      },
      "expectedStatus": 409,
      "expectedResponse": {
        "success": false,
        "errorCode": "USER_ALREADY_EXISTS"
      }
    }
  ]
}
```

### 性能测试指标

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| **响应时间** | <200ms | 压力测试 |
| **并发用户** | 1000+ | 负载测试 |
| **吞吐量** | 500 TPS | 性能测试 |
| **可用性** | 99.9% | 可靠性测试 |

---

## 📚 最佳实践总结

### ✅ 推荐做法

1. **统一错误处理**：使用标准化的错误响应格式
2. **参数验证**：在业务逻辑前进行严格的参数验证
3. **日志记录**：记录关键操作的详细日志
4. **接口版本管理**：合理规划接口版本演进
5. **性能监控**：监控接口响应时间和错误率
6. **文档维护**：保持接口文档与实现同步

### ❌ 避免的问题

1. **状态码误用**：不要使用错误的HTTP状态码
2. **响应格式不一致**：避免不同接口返回不同的数据结构
3. **敏感信息暴露**：不要在响应中返回密码等敏感信息
4. **缺乏验证**：不要忽略输入参数的验证
5. **硬编码**：避免在接口中硬编码业务逻辑
6. **过度设计**：不要过度复杂化简单的接口

---

## 📚 相关文档

- [系统架构图模板](系统架构图模板.md)
- [技术选型决策表](技术选型决策表.md)
- [架构风险评估表](架构风险评估表.md)
- [部署架构图模板](部署架构图模板.md)

---

**创建时间**：{当前日期}  
**更新时间**：{当前日期}  
**版本号**：v1.0
