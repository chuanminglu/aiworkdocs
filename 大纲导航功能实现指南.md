# 大纲导航功能实现指南

## 1. 功能概述

大纲导航功能是模板编辑器的核心组件之一，类似于Microsoft Word的文档结构导航功能。它提供了一个清晰的文档结构视图，帮助用户快速理解和导航文档内容。

## 2. 核心特性

### 2.1 自动标题识别
- 支持Markdown标题格式（#, ##, ###, ####, #####, ######）
- 支持HTML标题格式（h1, h2, h3, h4, h5, h6）
- 实时解析文档内容，自动更新大纲结构

### 2.2 层次化显示
- 树形结构展示文档层级关系
- 支持任意深度的嵌套结构
- 清晰的视觉层级指示

### 2.3 交互功能
- 点击节点快速跳转到对应内容
- 双向同步：编辑器光标位置与大纲高亮同步
- 节点折叠/展开控制
- 右键菜单操作

## 3. 技术架构

### 3.1 核心类设计

```python
class DocumentOutlineNavigator:
    """文档大纲导航器
    
    负责解析文档结构，生成大纲数据，处理导航逻辑
    """
    
    def __init__(self, editor_instance):
        self.editor = editor_instance
        self.outline_tree = []
        self.current_position = None
        self.parser = OutlineParser()
        self.update_timer = None
    
    def parse_document(self, content: str) -> List[Dict]:
        """解析文档内容，生成大纲数据"""
        pass
    
    def jump_to_heading(self, heading_info: Dict):
        """跳转到指定标题位置"""
        pass
    
    def sync_current_position(self, current_line: int):
        """同步当前编辑位置"""
        pass

class OutlineTreeWidget:
    """大纲树形控件
    
    负责大纲的UI展示和用户交互
    """
    
    def __init__(self, parent):
        self.parent = parent
        self.tree_widget = QTreeWidget()
        self.setup_ui()
    
    def update_tree(self, outline_data: List[Dict]):
        """更新大纲树数据"""
        pass
    
    def highlight_current_section(self, line_number: int):
        """高亮当前章节"""
        pass

class OutlinePanel:
    """大纲导航面板
    
    整合导航器和树形控件，提供完整的大纲导航功能
    """
    
    def __init__(self, editor_widget):
        self.editor = editor_widget
        self.navigator = DocumentOutlineNavigator(editor_widget)
        self.tree_widget = OutlineTreeWidget(self)
        self.setup_panel()
```

### 3.2 标题识别算法

```python
class OutlineParser:
    """大纲解析器"""
    
    def extract_headings(self, content: str) -> List[Dict]:
        """提取标题信息"""
        headings = []
        lines = content.split('\n')
        
        for line_num, line in enumerate(lines):
            # Markdown标题识别
            md_heading = self._parse_markdown_heading(line, line_num)
            if md_heading:
                headings.append(md_heading)
                continue
            
            # HTML标题识别
            html_heading = self._parse_html_heading(line, line_num)
            if html_heading:
                headings.append(html_heading)
        
        return headings
    
    def _parse_markdown_heading(self, line: str, line_num: int) -> Optional[Dict]:
        """解析Markdown标题"""
        import re
        pattern = r'^(#{1,6})\s+(.+)'
        match = re.match(pattern, line.strip())
        
        if match:
            level = len(match.group(1))
            text = match.group(2).strip()
            return {
                'line': line_num + 1,
                'column': 0,
                'level': level,
                'text': text,
                'type': 'markdown',
                'raw': line
            }
        return None
    
    def _parse_html_heading(self, line: str, line_num: int) -> Optional[Dict]:
        """解析HTML标题"""
        import re
        pattern = r'<h([1-6])[^>]*>([^<]+)</h[1-6]>'
        match = re.search(pattern, line)
        
        if match:
            level = int(match.group(1))
            text = match.group(2).strip()
            return {
                'line': line_num + 1,
                'column': match.start(),
                'level': level,
                'text': text,
                'type': 'html',
                'raw': line
            }
        return None
```

## 4. UI设计规范

### 4.1 面板布局
```
┌─────────────────────────────────────────────────────────┐
│ 📑 文档大纲                                🔄 ⚙️ 🔍      │
├─────────────────────────────────────────────────────────┤
│ 📄 技术研究笔记                                         │
│ ├─🎯 研究目标                                           │
│ ├─📋 知识框架                                           │
│ │ ├─核心概念                                             │
│ │ ├─技术栈                                               │
│ │ └─工具链                                               │
│ ├─🔬 实践案例                                           │
│ │ ├─案例1                                                │
│ │ └─案例2                                                │
│ ├─✅ 最佳实践                                           │
│ ├─❓ 问题解决                                           │
│ ├─🔄 进阶方向                                           │
│ ├─📚 参考资料                                           │
│ ├─💭 个人思考                                           │
│ └─📋 后续行动                                           │
├─────────────────────────────────────────────────────────┤
│ 📊 14个标题 | 📏 3层深度                                │
└─────────────────────────────────────────────────────────┘
```

### 4.2 视觉设计
- **图标系统**：使用统一的emoji图标区分不同层级
- **颜色方案**：暗色主题，突出显示当前选中项
- **字体规格**：清晰易读，支持中英文混合显示
- **间距设计**：合理的行间距和缩进，提升阅读体验

### 4.3 交互设计
- **点击跳转**：单击节点立即跳转，无需双击
- **实时同步**：编辑器光标移动时，大纲自动高亮对应节点
- **右键菜单**：提供跳转、编辑、复制、折叠等快捷操作
- **键盘导航**：支持上下箭头键在大纲中导航

## 5. 实现步骤

### 5.1 第一阶段：基础框架（1天）
1. 创建核心类结构
2. 实现基本的标题识别算法
3. 构建树形控件UI
4. 建立编辑器与大纲的连接

### 5.2 第二阶段：核心功能（1天）
1. 完善标题解析逻辑
2. 实现点击跳转功能
3. 添加实时同步机制
4. 实现节点折叠/展开

### 5.3 第三阶段：高级功能（0.5天）
1. 添加搜索和过滤功能
2. 实现右键菜单
3. 集成快捷键支持
4. 完善错误处理和边界情况

### 5.4 第四阶段：优化和测试（0.5天）
1. 性能优化（大文档处理）
2. UI细节调整
3. 功能测试和bug修复
4. 用户体验优化

## 6. 配置选项

### 6.1 用户可配置项
```json
{
  "outline_settings": {
    "auto_refresh": true,
    "refresh_delay": 500,
    "show_line_numbers": true,
    "auto_expand_on_jump": true,
    "highlight_current_section": true,
    "max_heading_length": 50,
    "show_empty_sections": false,
    "sync_with_editor": true,
    "default_collapsed_level": 3,
    "enable_search": true,
    "show_statistics": true
  }
}
```

### 6.2 主题配置
```json
{
  "outline_theme": {
    "background_color": "#2d3748",
    "text_color": "#e2e8f0",
    "selected_color": "#3182ce",
    "hover_color": "#4a5568",
    "border_color": "#4a5568",
    "font_family": "Microsoft YaHei",
    "font_size": 13,
    "line_height": 1.4,
    "indent_size": 20
  }
}
```

## 7. 测试用例

### 7.1 基础功能测试
- 标题识别准确性测试
- 树形结构生成测试
- 点击跳转功能测试
- 实时同步测试

### 7.2 边界情况测试
- 空文档处理
- 超长标题处理
- 深层嵌套结构
- 特殊字符处理

### 7.3 性能测试
- 大文档解析性能
- 实时更新性能
- 内存使用情况
- UI响应速度

### 7.4 用户体验测试
- 界面布局合理性
- 交互流畅性
- 功能易用性
- 错误处理友好性

## 8. 扩展功能

### 8.1 未来改进方向
1. **智能大纲生成**：基于AI的大纲结构优化建议
2. **大纲模板**：预设的大纲结构模板
3. **协作功能**：多人编辑时的大纲同步
4. **导出功能**：导出大纲为单独文件
5. **大纲统计**：更详细的文档结构分析

### 8.2 集成可能性
1. **与AI服务集成**：智能大纲建议
2. **与搜索集成**：基于大纲的搜索
3. **与版本控制集成**：大纲结构的版本比较
4. **与协作系统集成**：大纲级别的评论和建议

## 9. 性能优化建议

### 9.1 解析优化
- 使用增量解析，只处理变化的部分
- 缓存解析结果，避免重复计算
- 使用正则表达式预编译

### 9.2 UI优化
- 虚拟滚动处理大量节点
- 延迟加载深层嵌套内容
- 使用节流机制处理频繁更新

### 9.3 内存优化
- 及时清理不再需要的数据
- 使用弱引用避免循环引用
- 优化数据结构，减少内存占用

## 10. 总结

大纲导航功能是提升用户文档编辑体验的重要功能，通过清晰的结构视图和便捷的导航操作，用户可以更高效地管理和编辑长文档。实现时需要重点关注性能优化和用户体验，确保在处理大型文档时依然保持良好的响应速度。
